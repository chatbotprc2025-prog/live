{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/TECHNOSOFT/Downloads/test-main/PCE_Assistant-main/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\n// Lazy initialization - only create client when first accessed\nfunction getPrismaClient(): PrismaClient {\n  if (globalForPrisma.prisma) {\n    return globalForPrisma.prisma;\n  }\n\n  // Safely get and clean DATABASE_URL\n  const rawDatabaseUrl = process.env.DATABASE_URL;\n  if (!rawDatabaseUrl || typeof rawDatabaseUrl !== 'string') {\n    throw new Error('DATABASE_URL environment variable is not set. Please add it to your .env file.');\n  }\n  \n  // Ensure it's a string and clean it\n  let databaseUrl: string;\n  try {\n    databaseUrl = String(rawDatabaseUrl).trim();\n    if (databaseUrl) {\n      databaseUrl = databaseUrl.replace(/^[\"']|[\"']$/g, '');\n    }\n  } catch (error) {\n    throw new Error(`Failed to parse DATABASE_URL: ${error}`);\n  }\n  \n  if (!databaseUrl) {\n    throw new Error('DATABASE_URL is empty after parsing.');\n  }\n  let client: PrismaClient;\n\n  if (databaseUrl && databaseUrl.startsWith('file:')) {\n    // SQLite - use better-sqlite3 adapter (required for Prisma 7)\n    try {\n      const { PrismaBetterSqlite3 } = require('@prisma/adapter-better-sqlite3');\n      const Database = require('better-sqlite3');\n      const path = require('path');\n      \n      // Extract database path from DATABASE_URL\n      // Format: \"file:./prisma/dev.db\" or \"file:///absolute/path\" or \"file://relative/path\"\n      let dbPath = databaseUrl.replace(/^file:/i, '').replace(/^\\/+/, '');\n      dbPath = dbPath.replace(/^[\"']|[\"']$/g, ''); // Remove quotes\n      \n      // Handle relative paths\n      if (dbPath.startsWith('./')) {\n        dbPath = dbPath.substring(2);\n      }\n      \n      // Resolve to absolute path\n      const absolutePath = path.resolve(process.cwd(), dbPath);\n      \n      // Create adapter - pass config object with url property\n      const adapter = new PrismaBetterSqlite3({\n        url: absolutePath,\n      });\n      \n      client = new PrismaClient({\n        adapter,\n        log: process.env.NODE_ENV === 'development' ? ['error', 'warn'] : [],\n      });\n    } catch (error: any) {\n      console.error('Failed to initialize SQLite with adapter:', error);\n      console.error('Database URL:', databaseUrl);\n      console.error('Error details:', error?.message, error?.stack);\n      throw new Error(`Failed to initialize Prisma with SQLite: ${error?.message || error}`);\n    }\n  } else if (databaseUrl.startsWith('postgresql://') || databaseUrl.startsWith('postgres://')) {\n    // PostgreSQL - use adapter\n    try {\n      const { PrismaPg } = require('@prisma/adapter-pg');\n      const { Pool } = require('pg');\n      const pool = new Pool({ connectionString: databaseUrl });\n      const adapter = new PrismaPg(pool);\n      client = new PrismaClient({\n        adapter,\n        log: process.env.NODE_ENV === 'development' ? ['error', 'warn'] : [],\n      });\n    } catch (error) {\n      console.error('Failed to create postgres adapter:', error);\n      client = new PrismaClient({\n        log: process.env.NODE_ENV === 'development' ? ['error', 'warn'] : [],\n      });\n    }\n  } else {\n    // Default: try standard client\n    client = new PrismaClient({\n      log: process.env.NODE_ENV === 'development' ? ['error', 'warn'] : [],\n    });\n  }\n\n  if (process.env.NODE_ENV !== 'production') {\n    globalForPrisma.prisma = client;\n  }\n\n  return client;\n}\n\n// Export a proxy that lazily initializes the client\nexport const prisma = new Proxy({} as PrismaClient, {\n  get(_target, prop) {\n    const client = getPrismaClient();\n    const value = (client as any)[prop];\n    if (typeof value === 'function') {\n      return value.bind(client);\n    }\n    return value;\n  },\n}) as PrismaClient;\n\nexport default prisma;\n\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM,kBAAkB;AAIxB,+DAA+D;AAC/D,SAAS;IACP,IAAI,gBAAgB,MAAM,EAAE;QAC1B,OAAO,gBAAgB,MAAM;IAC/B;IAEA,oCAAoC;IACpC,MAAM,iBAAiB,QAAQ,GAAG,CAAC,YAAY;IAC/C,IAAI,CAAC,kBAAkB,OAAO,mBAAmB,UAAU;QACzD,MAAM,IAAI,MAAM;IAClB;IAEA,oCAAoC;IACpC,IAAI;IACJ,IAAI;QACF,cAAc,OAAO,gBAAgB,IAAI;QACzC,IAAI,aAAa;YACf,cAAc,YAAY,OAAO,CAAC,gBAAgB;QACpD;IACF,EAAE,OAAO,OAAO;QACd,MAAM,IAAI,MAAM,CAAC,8BAA8B,EAAE,OAAO;IAC1D;IAEA,IAAI,CAAC,aAAa;QAChB,MAAM,IAAI,MAAM;IAClB;IACA,IAAI;IAEJ,IAAI,eAAe,YAAY,UAAU,CAAC,UAAU;QAClD,8DAA8D;QAC9D,IAAI;YACF,MAAM,EAAE,mBAAmB,EAAE;YAC7B,MAAM;YACN,MAAM;YAEN,0CAA0C;YAC1C,sFAAsF;YACtF,IAAI,SAAS,YAAY,OAAO,CAAC,WAAW,IAAI,OAAO,CAAC,QAAQ;YAChE,SAAS,OAAO,OAAO,CAAC,gBAAgB,KAAK,gBAAgB;YAE7D,wBAAwB;YACxB,IAAI,OAAO,UAAU,CAAC,OAAO;gBAC3B,SAAS,OAAO,SAAS,CAAC;YAC5B;YAEA,2BAA2B;YAC3B,MAAM,eAAe,KAAK,OAAO,CAAC,QAAQ,GAAG,IAAI;YAEjD,wDAAwD;YACxD,MAAM,UAAU,IAAI,oBAAoB;gBACtC,KAAK;YACP;YAEA,SAAS,IAAI,6IAAY,CAAC;gBACxB;gBACA,KAAK,uCAAyC;oBAAC;oBAAS;iBAAO,GAAG;YACpE;QACF,EAAE,OAAO,OAAY;YACnB,QAAQ,KAAK,CAAC,6CAA6C;YAC3D,QAAQ,KAAK,CAAC,iBAAiB;YAC/B,QAAQ,KAAK,CAAC,kBAAkB,OAAO,SAAS,OAAO;YACvD,MAAM,IAAI,MAAM,CAAC,yCAAyC,EAAE,OAAO,WAAW,OAAO;QACvF;IACF,OAAO,IAAI,YAAY,UAAU,CAAC,oBAAoB,YAAY,UAAU,CAAC,gBAAgB;QAC3F,2BAA2B;QAC3B,IAAI;YACF,MAAM,EAAE,QAAQ,EAAE;YAClB,MAAM,EAAE,IAAI,EAAE;YACd,MAAM,OAAO,IAAI,KAAK;gBAAE,kBAAkB;YAAY;YACtD,MAAM,UAAU,IAAI,SAAS;YAC7B,SAAS,IAAI,6IAAY,CAAC;gBACxB;gBACA,KAAK,uCAAyC;oBAAC;oBAAS;iBAAO,GAAG;YACpE;QACF,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,sCAAsC;YACpD,SAAS,IAAI,6IAAY,CAAC;gBACxB,KAAK,uCAAyC;oBAAC;oBAAS;iBAAO,GAAG;YACpE;QACF;IACF,OAAO;QACL,+BAA+B;QAC/B,SAAS,IAAI,6IAAY,CAAC;YACxB,KAAK,uCAAyC;gBAAC;gBAAS;aAAO,GAAG;QACpE;IACF;IAEA,wCAA2C;QACzC,gBAAgB,MAAM,GAAG;IAC3B;IAEA,OAAO;AACT;AAGO,MAAM,SAAS,IAAI,MAAM,CAAC,GAAmB;IAClD,KAAI,OAAO,EAAE,IAAI;QACf,MAAM,SAAS;QACf,MAAM,QAAQ,AAAC,MAAc,CAAC,KAAK;QACnC,IAAI,OAAO,UAAU,YAAY;YAC/B,OAAO,MAAM,IAAI,CAAC;QACpB;QACA,OAAO;IACT;AACF;uCAEe"}},
    {"offset": {"line": 214, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/TECHNOSOFT/Downloads/test-main/PCE_Assistant-main/lib/auth.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport jwt from 'jsonwebtoken';\nimport bcrypt from 'bcryptjs';\nimport { prisma } from './prisma';\n\nconst JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key-change-in-production';\n\nexport interface JWTPayload {\n  userId: string;\n  email: string;\n  role: string;\n}\n\nexport async function hashPassword(password: string): Promise<string> {\n  return bcrypt.hash(password, 10);\n}\n\nexport async function verifyPassword(password: string, hash: string): Promise<boolean> {\n  return bcrypt.compare(password, hash);\n}\n\nexport function generateToken(payload: JWTPayload): string {\n  return jwt.sign(payload, JWT_SECRET, { expiresIn: '7d' });\n}\n\nexport function verifyToken(token: string): JWTPayload | null {\n  try {\n    return jwt.verify(token, JWT_SECRET) as JWTPayload;\n  } catch {\n    return null;\n  }\n}\n\nexport function getTokenFromRequest(request: NextRequest): string | null {\n  return request.cookies.get('auth-token')?.value || null;\n}\n\nexport async function getCurrentUser(request: NextRequest): Promise<JWTPayload | null> {\n  const token = getTokenFromRequest(request);\n  if (!token) return null;\n  \n  const payload = verifyToken(token);\n  if (!payload) return null;\n  \n  // Verify user still exists\n  const user = await prisma.user.findUnique({\n    where: { id: payload.userId },\n  });\n  \n  if (!user) return null;\n  \n  return payload;\n}\n\nexport function setAuthCookie(response: NextResponse, token: string): void {\n  response.cookies.set('auth-token', token, {\n    httpOnly: true,\n    secure: process.env.NODE_ENV === 'production',\n    sameSite: 'lax',\n    maxAge: 60 * 60 * 24 * 7, // 7 days\n    path: '/',\n  });\n}\n\nexport function clearAuthCookie(response: NextResponse): void {\n  response.cookies.delete('auth-token');\n}\n\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AACA;AACA;AACA;;;;AAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAQtC,eAAe,aAAa,QAAgB;IACjD,OAAO,8IAAM,CAAC,IAAI,CAAC,UAAU;AAC/B;AAEO,eAAe,eAAe,QAAgB,EAAE,IAAY;IACjE,OAAO,8IAAM,CAAC,OAAO,CAAC,UAAU;AAClC;AAEO,SAAS,cAAc,OAAmB;IAC/C,OAAO,kJAAG,CAAC,IAAI,CAAC,SAAS,YAAY;QAAE,WAAW;IAAK;AACzD;AAEO,SAAS,YAAY,KAAa;IACvC,IAAI;QACF,OAAO,kJAAG,CAAC,MAAM,CAAC,OAAO;IAC3B,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,SAAS,oBAAoB,OAAoB;IACtD,OAAO,QAAQ,OAAO,CAAC,GAAG,CAAC,eAAe,SAAS;AACrD;AAEO,eAAe,eAAe,OAAoB;IACvD,MAAM,QAAQ,oBAAoB;IAClC,IAAI,CAAC,OAAO,OAAO;IAEnB,MAAM,UAAU,YAAY;IAC5B,IAAI,CAAC,SAAS,OAAO;IAErB,2BAA2B;IAC3B,MAAM,OAAO,MAAM,yHAAM,CAAC,IAAI,CAAC,UAAU,CAAC;QACxC,OAAO;YAAE,IAAI,QAAQ,MAAM;QAAC;IAC9B;IAEA,IAAI,CAAC,MAAM,OAAO;IAElB,OAAO;AACT;AAEO,SAAS,cAAc,QAAsB,EAAE,KAAa;IACjE,SAAS,OAAO,CAAC,GAAG,CAAC,cAAc,OAAO;QACxC,UAAU;QACV,QAAQ,oDAAyB;QACjC,UAAU;QACV,QAAQ,KAAK,KAAK,KAAK;QACvB,MAAM;IACR;AACF;AAEO,SAAS,gBAAgB,QAAsB;IACpD,SAAS,OAAO,CAAC,MAAM,CAAC;AAC1B"}},
    {"offset": {"line": 290, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/TECHNOSOFT/Downloads/test-main/PCE_Assistant-main/app/api/admin/rooms/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { prisma } from '@/lib/prisma';\nimport { getCurrentUser } from '@/lib/auth';\n\n// GET - List all rooms\nexport async function GET(request: NextRequest) {\n  try {\n    const user = await getCurrentUser(request);\n    if (!user) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n    }\n\n    const rooms = await prisma.room.findMany({\n      orderBy: [{ buildingName: 'asc' }, { floor: 'asc' }, { roomCode: 'asc' }],\n    });\n\n    return NextResponse.json(rooms);\n  } catch (error) {\n    console.error('Rooms GET error:', error);\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\n// POST - Create new room\nexport async function POST(request: NextRequest) {\n  try {\n    const user = await getCurrentUser(request);\n    if (!user) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n    }\n\n    const body = await request.json();\n    const { roomCode, buildingName, floor, textDirections, latitude, longitude } = body;\n\n    if (!roomCode || !buildingName || !floor) {\n      return NextResponse.json(\n        { error: 'Room code, building name, and floor are required' },\n        { status: 400 }\n      );\n    }\n\n    const room = await prisma.room.create({\n      data: {\n        roomCode,\n        buildingName,\n        floor,\n        textDirections,\n        latitude: latitude ? parseFloat(latitude) : null,\n        longitude: longitude ? parseFloat(longitude) : null,\n      },\n    });\n\n    // Audit log\n    await prisma.auditLog.create({\n      data: {\n        actorId: user.userId,\n        action: 'ROOM_CREATE',\n        entityType: 'Room',\n        entityId: room.id,\n        severity: 'INFO',\n      },\n    });\n\n    return NextResponse.json(room);\n  } catch (error) {\n    console.error('Rooms POST error:', error);\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;;;;AAGO,eAAe,IAAI,OAAoB;IAC5C,IAAI;QACF,MAAM,OAAO,MAAM,IAAA,+HAAc,EAAC;QAClC,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,MAAM,QAAQ,MAAM,yHAAM,CAAC,IAAI,CAAC,QAAQ,CAAC;YACvC,SAAS;gBAAC;oBAAE,cAAc;gBAAM;gBAAG;oBAAE,OAAO;gBAAM;gBAAG;oBAAE,UAAU;gBAAM;aAAE;QAC3E;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,oBAAoB;QAClC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAwB,GACjC;YAAE,QAAQ;QAAI;IAElB;AACF;AAGO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,MAAM,OAAO,MAAM,IAAA,+HAAc,EAAC;QAClC,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAe,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,EAAE,QAAQ,EAAE,YAAY,EAAE,KAAK,EAAE,cAAc,EAAE,QAAQ,EAAE,SAAS,EAAE,GAAG;QAE/E,IAAI,CAAC,YAAY,CAAC,gBAAgB,CAAC,OAAO;YACxC,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAmD,GAC5D;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,OAAO,MAAM,yHAAM,CAAC,IAAI,CAAC,MAAM,CAAC;YACpC,MAAM;gBACJ;gBACA;gBACA;gBACA;gBACA,UAAU,WAAW,WAAW,YAAY;gBAC5C,WAAW,YAAY,WAAW,aAAa;YACjD;QACF;QAEA,YAAY;QACZ,MAAM,yHAAM,CAAC,QAAQ,CAAC,MAAM,CAAC;YAC3B,MAAM;gBACJ,SAAS,KAAK,MAAM;gBACpB,QAAQ;gBACR,YAAY;gBACZ,UAAU,KAAK,EAAE;gBACjB,UAAU;YACZ;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qBAAqB;QACnC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAwB,GACjC;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}