{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/TECHNOSOFT/Downloads/test-main/PCE_Assistant-main/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\n// Lazy initialization - only create client when first accessed\nfunction getPrismaClient(): PrismaClient {\n  if (globalForPrisma.prisma) {\n    return globalForPrisma.prisma;\n  }\n\n  // Safely get and clean DATABASE_URL\n  const rawDatabaseUrl = process.env.DATABASE_URL;\n  if (!rawDatabaseUrl || typeof rawDatabaseUrl !== 'string') {\n    throw new Error('DATABASE_URL environment variable is not set. Please add it to your .env file.');\n  }\n  \n  // Ensure it's a string and clean it\n  let databaseUrl: string;\n  try {\n    databaseUrl = String(rawDatabaseUrl).trim();\n    if (databaseUrl) {\n      databaseUrl = databaseUrl.replace(/^[\"']|[\"']$/g, '');\n    }\n  } catch (error) {\n    throw new Error(`Failed to parse DATABASE_URL: ${error}`);\n  }\n  \n  if (!databaseUrl) {\n    throw new Error('DATABASE_URL is empty after parsing.');\n  }\n  let client: PrismaClient;\n\n  if (databaseUrl && databaseUrl.startsWith('file:')) {\n    // SQLite - use better-sqlite3 adapter (required for Prisma 7)\n    try {\n      const { PrismaBetterSqlite3 } = require('@prisma/adapter-better-sqlite3');\n      const Database = require('better-sqlite3');\n      const path = require('path');\n      \n      // Extract database path from DATABASE_URL\n      // Format: \"file:./prisma/dev.db\" or \"file:///absolute/path\" or \"file://relative/path\"\n      let dbPath = databaseUrl.replace(/^file:/i, '').replace(/^\\/+/, '');\n      dbPath = dbPath.replace(/^[\"']|[\"']$/g, ''); // Remove quotes\n      \n      // Handle relative paths\n      if (dbPath.startsWith('./')) {\n        dbPath = dbPath.substring(2);\n      }\n      \n      // Resolve to absolute path\n      const absolutePath = path.resolve(process.cwd(), dbPath);\n      \n      // Create adapter - pass config object with url property\n      const adapter = new PrismaBetterSqlite3({\n        url: absolutePath,\n      });\n      \n      client = new PrismaClient({\n        adapter,\n        log: process.env.NODE_ENV === 'development' ? ['error', 'warn'] : [],\n      });\n    } catch (error: any) {\n      console.error('Failed to initialize SQLite with adapter:', error);\n      console.error('Database URL:', databaseUrl);\n      console.error('Error details:', error?.message, error?.stack);\n      throw new Error(`Failed to initialize Prisma with SQLite: ${error?.message || error}`);\n    }\n  } else if (databaseUrl.startsWith('postgresql://') || databaseUrl.startsWith('postgres://')) {\n    // PostgreSQL - use adapter\n    try {\n      const { PrismaPg } = require('@prisma/adapter-pg');\n      const { Pool } = require('pg');\n      const pool = new Pool({ connectionString: databaseUrl });\n      const adapter = new PrismaPg(pool);\n      client = new PrismaClient({\n        adapter,\n        log: process.env.NODE_ENV === 'development' ? ['error', 'warn'] : [],\n      });\n    } catch (error) {\n      console.error('Failed to create postgres adapter:', error);\n      client = new PrismaClient({\n        log: process.env.NODE_ENV === 'development' ? ['error', 'warn'] : [],\n      });\n    }\n  } else {\n    // Default: try standard client\n    client = new PrismaClient({\n      log: process.env.NODE_ENV === 'development' ? ['error', 'warn'] : [],\n    });\n  }\n\n  if (process.env.NODE_ENV !== 'production') {\n    globalForPrisma.prisma = client;\n  }\n\n  return client;\n}\n\n// Export a proxy that lazily initializes the client\nexport const prisma = new Proxy({} as PrismaClient, {\n  get(_target, prop) {\n    const client = getPrismaClient();\n    const value = (client as any)[prop];\n    if (typeof value === 'function') {\n      return value.bind(client);\n    }\n    return value;\n  },\n}) as PrismaClient;\n\nexport default prisma;\n\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM,kBAAkB;AAIxB,+DAA+D;AAC/D,SAAS;IACP,IAAI,gBAAgB,MAAM,EAAE;QAC1B,OAAO,gBAAgB,MAAM;IAC/B;IAEA,oCAAoC;IACpC,MAAM,iBAAiB,QAAQ,GAAG,CAAC,YAAY;IAC/C,IAAI,CAAC,kBAAkB,OAAO,mBAAmB,UAAU;QACzD,MAAM,IAAI,MAAM;IAClB;IAEA,oCAAoC;IACpC,IAAI;IACJ,IAAI;QACF,cAAc,OAAO,gBAAgB,IAAI;QACzC,IAAI,aAAa;YACf,cAAc,YAAY,OAAO,CAAC,gBAAgB;QACpD;IACF,EAAE,OAAO,OAAO;QACd,MAAM,IAAI,MAAM,CAAC,8BAA8B,EAAE,OAAO;IAC1D;IAEA,IAAI,CAAC,aAAa;QAChB,MAAM,IAAI,MAAM;IAClB;IACA,IAAI;IAEJ,IAAI,eAAe,YAAY,UAAU,CAAC,UAAU;QAClD,8DAA8D;QAC9D,IAAI;YACF,MAAM,EAAE,mBAAmB,EAAE;YAC7B,MAAM;YACN,MAAM;YAEN,0CAA0C;YAC1C,sFAAsF;YACtF,IAAI,SAAS,YAAY,OAAO,CAAC,WAAW,IAAI,OAAO,CAAC,QAAQ;YAChE,SAAS,OAAO,OAAO,CAAC,gBAAgB,KAAK,gBAAgB;YAE7D,wBAAwB;YACxB,IAAI,OAAO,UAAU,CAAC,OAAO;gBAC3B,SAAS,OAAO,SAAS,CAAC;YAC5B;YAEA,2BAA2B;YAC3B,MAAM,eAAe,KAAK,OAAO,CAAC,QAAQ,GAAG,IAAI;YAEjD,wDAAwD;YACxD,MAAM,UAAU,IAAI,oBAAoB;gBACtC,KAAK;YACP;YAEA,SAAS,IAAI,6IAAY,CAAC;gBACxB;gBACA,KAAK,uCAAyC;oBAAC;oBAAS;iBAAO,GAAG;YACpE;QACF,EAAE,OAAO,OAAY;YACnB,QAAQ,KAAK,CAAC,6CAA6C;YAC3D,QAAQ,KAAK,CAAC,iBAAiB;YAC/B,QAAQ,KAAK,CAAC,kBAAkB,OAAO,SAAS,OAAO;YACvD,MAAM,IAAI,MAAM,CAAC,yCAAyC,EAAE,OAAO,WAAW,OAAO;QACvF;IACF,OAAO,IAAI,YAAY,UAAU,CAAC,oBAAoB,YAAY,UAAU,CAAC,gBAAgB;QAC3F,2BAA2B;QAC3B,IAAI;YACF,MAAM,EAAE,QAAQ,EAAE;YAClB,MAAM,EAAE,IAAI,EAAE;YACd,MAAM,OAAO,IAAI,KAAK;gBAAE,kBAAkB;YAAY;YACtD,MAAM,UAAU,IAAI,SAAS;YAC7B,SAAS,IAAI,6IAAY,CAAC;gBACxB;gBACA,KAAK,uCAAyC;oBAAC;oBAAS;iBAAO,GAAG;YACpE;QACF,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,sCAAsC;YACpD,SAAS,IAAI,6IAAY,CAAC;gBACxB,KAAK,uCAAyC;oBAAC;oBAAS;iBAAO,GAAG;YACpE;QACF;IACF,OAAO;QACL,+BAA+B;QAC/B,SAAS,IAAI,6IAAY,CAAC;YACxB,KAAK,uCAAyC;gBAAC;gBAAS;aAAO,GAAG;QACpE;IACF;IAEA,wCAA2C;QACzC,gBAAgB,MAAM,GAAG;IAC3B;IAEA,OAAO;AACT;AAGO,MAAM,SAAS,IAAI,MAAM,CAAC,GAAmB;IAClD,KAAI,OAAO,EAAE,IAAI;QACf,MAAM,SAAS;QACf,MAAM,QAAQ,AAAC,MAAc,CAAC,KAAK;QACnC,IAAI,OAAO,UAAU,YAAY;YAC/B,OAAO,MAAM,IAAI,CAAC;QACpB;QACA,OAAO;IACT;AACF;uCAEe"}},
    {"offset": {"line": 190, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/TECHNOSOFT/Downloads/test-main/PCE_Assistant-main/app/api/conversations/%5Bid%5D/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { prisma } from '@/lib/prisma';\r\n\r\n// GET - Get conversation with messages\r\nexport async function GET(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const { id } = await params;\r\n\r\n    if (!id) {\r\n      return NextResponse.json(\r\n        { error: 'Conversation ID is required' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const conversation = await prisma.conversation.findUnique({\r\n      where: { id },\r\n      include: {\r\n        messages: {\r\n          orderBy: { createdAt: 'asc' },\r\n        },\r\n      },\r\n    });\r\n\r\n    if (!conversation) {\r\n      return NextResponse.json({ error: 'Conversation not found' }, { status: 404 });\r\n    }\r\n\r\n    // Parse images from JSON string for each message\r\n    const conversationWithParsedImages = {\r\n      ...conversation,\r\n      messages: conversation.messages.map((msg: any) => ({\r\n        ...msg,\r\n        images: msg.images ? (() => {\r\n          try {\r\n            const parsed = JSON.parse(msg.images);\r\n            return Array.isArray(parsed) ? parsed : null;\r\n          } catch {\r\n            return null;\r\n          }\r\n        })() : null,\r\n      })),\r\n    };\r\n\r\n    return NextResponse.json(conversationWithParsedImages);\r\n  } catch (error: any) {\r\n    console.error('Conversation GET error:', error);\r\n    return NextResponse.json(\r\n      { error: error?.message || 'Internal server error' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n// DELETE - Remove a conversation and its messages\r\nexport async function DELETE(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    const { id } = await params;\r\n\r\n    if (!id) {\r\n      return NextResponse.json(\r\n        { error: 'Conversation ID is required' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Attempt delete; cascade takes care of related messages\r\n    await prisma.conversation.delete({\r\n      where: { id },\r\n    });\r\n\r\n    return NextResponse.json({ success: true });\r\n  } catch (error: any) {\r\n    console.error('Conversation DELETE error:', error);\r\n    console.error('Error details:', {\r\n      code: error?.code,\r\n      message: error?.message,\r\n      meta: error?.meta,\r\n    });\r\n\r\n    // Handle not found explicitly\r\n    if (error?.code === 'P2025') {\r\n      return NextResponse.json(\r\n        { error: 'Conversation not found' },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    return NextResponse.json(\r\n      { error: error?.message || 'Internal server error' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAGO,eAAe,IACpB,OAAoB,EACpB,EAAE,MAAM,EAAuC;IAE/C,IAAI;QACF,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM;QAErB,IAAI,CAAC,IAAI;YACP,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA8B,GACvC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,eAAe,MAAM,yHAAM,CAAC,YAAY,CAAC,UAAU,CAAC;YACxD,OAAO;gBAAE;YAAG;YACZ,SAAS;gBACP,UAAU;oBACR,SAAS;wBAAE,WAAW;oBAAM;gBAC9B;YACF;QACF;QAEA,IAAI,CAAC,cAAc;YACjB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAyB,GAAG;gBAAE,QAAQ;YAAI;QAC9E;QAEA,iDAAiD;QACjD,MAAM,+BAA+B;YACnC,GAAG,YAAY;YACf,UAAU,aAAa,QAAQ,CAAC,GAAG,CAAC,CAAC,MAAa,CAAC;oBACjD,GAAG,GAAG;oBACN,QAAQ,IAAI,MAAM,GAAG,CAAC;wBACpB,IAAI;4BACF,MAAM,SAAS,KAAK,KAAK,CAAC,IAAI,MAAM;4BACpC,OAAO,MAAM,OAAO,CAAC,UAAU,SAAS;wBAC1C,EAAE,OAAM;4BACN,OAAO;wBACT;oBACF,CAAC,MAAM;gBACT,CAAC;QACH;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;IAC3B,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,2BAA2B;QACzC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO,OAAO,WAAW;QAAwB,GACnD;YAAE,QAAQ;QAAI;IAElB;AACF;AAGO,eAAe,OACpB,OAAoB,EACpB,EAAE,MAAM,EAAuC;IAE/C,IAAI;QACF,MAAM,EAAE,EAAE,EAAE,GAAG,MAAM;QAErB,IAAI,CAAC,IAAI;YACP,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA8B,GACvC;gBAAE,QAAQ;YAAI;QAElB;QAEA,yDAAyD;QACzD,MAAM,yHAAM,CAAC,YAAY,CAAC,MAAM,CAAC;YAC/B,OAAO;gBAAE;YAAG;QACd;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;IAC3C,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,QAAQ,KAAK,CAAC,kBAAkB;YAC9B,MAAM,OAAO;YACb,SAAS,OAAO;YAChB,MAAM,OAAO;QACf;QAEA,8BAA8B;QAC9B,IAAI,OAAO,SAAS,SAAS;YAC3B,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAyB,GAClC;gBAAE,QAAQ;YAAI;QAElB;QAEA,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO,OAAO,WAAW;QAAwB,GACnD;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}