{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/TECHNOSOFT/Downloads/test-main/PCE_Assistant-main/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\n// Lazy initialization - only create client when first accessed\nfunction getPrismaClient(): PrismaClient {\n  if (globalForPrisma.prisma) {\n    return globalForPrisma.prisma;\n  }\n\n  // Safely get and clean DATABASE_URL\n  const rawDatabaseUrl = process.env.DATABASE_URL;\n  if (!rawDatabaseUrl || typeof rawDatabaseUrl !== 'string') {\n    throw new Error('DATABASE_URL environment variable is not set. Please add it to your .env file.');\n  }\n  \n  // Ensure it's a string and clean it\n  let databaseUrl: string;\n  try {\n    databaseUrl = String(rawDatabaseUrl).trim();\n    if (databaseUrl) {\n      databaseUrl = databaseUrl.replace(/^[\"']|[\"']$/g, '');\n    }\n  } catch (error) {\n    throw new Error(`Failed to parse DATABASE_URL: ${error}`);\n  }\n  \n  if (!databaseUrl) {\n    throw new Error('DATABASE_URL is empty after parsing.');\n  }\n  let client: PrismaClient;\n\n  if (databaseUrl && databaseUrl.startsWith('file:')) {\n    // SQLite - use better-sqlite3 adapter (required for Prisma 7)\n    try {\n      const { PrismaBetterSqlite3 } = require('@prisma/adapter-better-sqlite3');\n      const Database = require('better-sqlite3');\n      const path = require('path');\n      \n      // Extract database path from DATABASE_URL\n      // Format: \"file:./prisma/dev.db\" or \"file:///absolute/path\" or \"file://relative/path\"\n      let dbPath = databaseUrl.replace(/^file:/i, '').replace(/^\\/+/, '');\n      dbPath = dbPath.replace(/^[\"']|[\"']$/g, ''); // Remove quotes\n      \n      // Handle relative paths\n      if (dbPath.startsWith('./')) {\n        dbPath = dbPath.substring(2);\n      }\n      \n      // Resolve to absolute path\n      const absolutePath = path.resolve(process.cwd(), dbPath);\n      \n      // Create adapter - pass config object with url property\n      const adapter = new PrismaBetterSqlite3({\n        url: absolutePath,\n      });\n      \n      client = new PrismaClient({\n        adapter,\n        log: process.env.NODE_ENV === 'development' ? ['error', 'warn'] : [],\n      });\n    } catch (error: any) {\n      console.error('Failed to initialize SQLite with adapter:', error);\n      console.error('Database URL:', databaseUrl);\n      console.error('Error details:', error?.message, error?.stack);\n      throw new Error(`Failed to initialize Prisma with SQLite: ${error?.message || error}`);\n    }\n  } else if (databaseUrl.startsWith('postgresql://') || databaseUrl.startsWith('postgres://')) {\n    // PostgreSQL - use adapter\n    try {\n      const { PrismaPg } = require('@prisma/adapter-pg');\n      const { Pool } = require('pg');\n      const pool = new Pool({ connectionString: databaseUrl });\n      const adapter = new PrismaPg(pool);\n      client = new PrismaClient({\n        adapter,\n        log: process.env.NODE_ENV === 'development' ? ['error', 'warn'] : [],\n      });\n    } catch (error) {\n      console.error('Failed to create postgres adapter:', error);\n      client = new PrismaClient({\n        log: process.env.NODE_ENV === 'development' ? ['error', 'warn'] : [],\n      });\n    }\n  } else {\n    // Default: try standard client\n    client = new PrismaClient({\n      log: process.env.NODE_ENV === 'development' ? ['error', 'warn'] : [],\n    });\n  }\n\n  if (process.env.NODE_ENV !== 'production') {\n    globalForPrisma.prisma = client;\n  }\n\n  return client;\n}\n\n// Export a proxy that lazily initializes the client\nexport const prisma = new Proxy({} as PrismaClient, {\n  get(_target, prop) {\n    const client = getPrismaClient();\n    const value = (client as any)[prop];\n    if (typeof value === 'function') {\n      return value.bind(client);\n    }\n    return value;\n  },\n}) as PrismaClient;\n\nexport default prisma;\n\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM,kBAAkB;AAIxB,+DAA+D;AAC/D,SAAS;IACP,IAAI,gBAAgB,MAAM,EAAE;QAC1B,OAAO,gBAAgB,MAAM;IAC/B;IAEA,oCAAoC;IACpC,MAAM,iBAAiB,QAAQ,GAAG,CAAC,YAAY;IAC/C,IAAI,CAAC,kBAAkB,OAAO,mBAAmB,UAAU;QACzD,MAAM,IAAI,MAAM;IAClB;IAEA,oCAAoC;IACpC,IAAI;IACJ,IAAI;QACF,cAAc,OAAO,gBAAgB,IAAI;QACzC,IAAI,aAAa;YACf,cAAc,YAAY,OAAO,CAAC,gBAAgB;QACpD;IACF,EAAE,OAAO,OAAO;QACd,MAAM,IAAI,MAAM,CAAC,8BAA8B,EAAE,OAAO;IAC1D;IAEA,IAAI,CAAC,aAAa;QAChB,MAAM,IAAI,MAAM;IAClB;IACA,IAAI;IAEJ,IAAI,eAAe,YAAY,UAAU,CAAC,UAAU;QAClD,8DAA8D;QAC9D,IAAI;YACF,MAAM,EAAE,mBAAmB,EAAE;YAC7B,MAAM;YACN,MAAM;YAEN,0CAA0C;YAC1C,sFAAsF;YACtF,IAAI,SAAS,YAAY,OAAO,CAAC,WAAW,IAAI,OAAO,CAAC,QAAQ;YAChE,SAAS,OAAO,OAAO,CAAC,gBAAgB,KAAK,gBAAgB;YAE7D,wBAAwB;YACxB,IAAI,OAAO,UAAU,CAAC,OAAO;gBAC3B,SAAS,OAAO,SAAS,CAAC;YAC5B;YAEA,2BAA2B;YAC3B,MAAM,eAAe,KAAK,OAAO,CAAC,QAAQ,GAAG,IAAI;YAEjD,wDAAwD;YACxD,MAAM,UAAU,IAAI,oBAAoB;gBACtC,KAAK;YACP;YAEA,SAAS,IAAI,6IAAY,CAAC;gBACxB;gBACA,KAAK,uCAAyC;oBAAC;oBAAS;iBAAO,GAAG;YACpE;QACF,EAAE,OAAO,OAAY;YACnB,QAAQ,KAAK,CAAC,6CAA6C;YAC3D,QAAQ,KAAK,CAAC,iBAAiB;YAC/B,QAAQ,KAAK,CAAC,kBAAkB,OAAO,SAAS,OAAO;YACvD,MAAM,IAAI,MAAM,CAAC,yCAAyC,EAAE,OAAO,WAAW,OAAO;QACvF;IACF,OAAO,IAAI,YAAY,UAAU,CAAC,oBAAoB,YAAY,UAAU,CAAC,gBAAgB;QAC3F,2BAA2B;QAC3B,IAAI;YACF,MAAM,EAAE,QAAQ,EAAE;YAClB,MAAM,EAAE,IAAI,EAAE;YACd,MAAM,OAAO,IAAI,KAAK;gBAAE,kBAAkB;YAAY;YACtD,MAAM,UAAU,IAAI,SAAS;YAC7B,SAAS,IAAI,6IAAY,CAAC;gBACxB;gBACA,KAAK,uCAAyC;oBAAC;oBAAS;iBAAO,GAAG;YACpE;QACF,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,sCAAsC;YACpD,SAAS,IAAI,6IAAY,CAAC;gBACxB,KAAK,uCAAyC;oBAAC;oBAAS;iBAAO,GAAG;YACpE;QACF;IACF,OAAO;QACL,+BAA+B;QAC/B,SAAS,IAAI,6IAAY,CAAC;YACxB,KAAK,uCAAyC;gBAAC;gBAAS;aAAO,GAAG;QACpE;IACF;IAEA,wCAA2C;QACzC,gBAAgB,MAAM,GAAG;IAC3B;IAEA,OAAO;AACT;AAGO,MAAM,SAAS,IAAI,MAAM,CAAC,GAAmB;IAClD,KAAI,OAAO,EAAE,IAAI;QACf,MAAM,SAAS;QACf,MAAM,QAAQ,AAAC,MAAc,CAAC,KAAK;QACnC,IAAI,OAAO,UAAU,YAAY;YAC/B,OAAO,MAAM,IAAI,CAAC;QACpB;QACA,OAAO;IACT;AACF;uCAEe"}},
    {"offset": {"line": 190, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/TECHNOSOFT/Downloads/test-main/PCE_Assistant-main/lib/chatHelpers.ts"],"sourcesContent":["import { prisma } from './prisma';\n\n/**\n * Check if message is a simple greeting\n */\nexport function isGreeting(message: string): boolean {\n  const lowerMessage = message.toLowerCase().trim();\n  const greetingPatterns = [\n    /^(hi|hello|hey|greetings|good morning|good afternoon|good evening|sup|what's up|wassup)$/i,\n    /^(hi|hello|hey)\\s*[!.]*$/i,\n    /^(hi|hello|hey)\\s+(there|everyone|all)$/i,\n  ];\n  \n  return greetingPatterns.some(pattern => pattern.test(lowerMessage));\n}\n\n/**\n * Intent detection - improved keyword-based classification\n */\nexport function detectIntent(message: string): string {\n  const lowerMessage = message.toLowerCase();\n  \n  // Check for greetings first\n  if (isGreeting(message)) {\n    return 'GREETING';\n  }\n  \n  // Fees intent - expanded keywords\n  if (lowerMessage.includes('fee') || lowerMessage.includes('tuition') || \n      lowerMessage.includes('payment') || lowerMessage.includes('cost') ||\n      lowerMessage.includes('price') || lowerMessage.includes('charges')) {\n    return 'FEES_INFO';\n  }\n  \n  // Staff/Faculty intent - expanded keywords and department abbreviations\n  if (lowerMessage.includes('teacher') || lowerMessage.includes('professor') || \n      lowerMessage.includes('hod') || lowerMessage.includes('faculty') || \n      lowerMessage.includes('staff') || lowerMessage.includes('head') ||\n      lowerMessage.includes('faculties') || lowerMessage.includes('facult') ||\n      lowerMessage.includes('cse') || lowerMessage.includes('computer science') ||\n      lowerMessage.includes('me') || lowerMessage.includes('mechanical') ||\n      lowerMessage.includes('ee') || lowerMessage.includes('electrical') ||\n      lowerMessage.includes('department') || lowerMessage.includes('dept')) {\n    return 'STAFF_INFO';\n  }\n  \n  // Directions intent\n  if (lowerMessage.includes('where') || lowerMessage.includes('location') || \n      lowerMessage.includes('room') || lowerMessage.includes('building') || \n      lowerMessage.includes('directions') || lowerMessage.includes('find') ||\n      lowerMessage.includes('how to reach') || lowerMessage.includes('how to get')) {\n    return 'DIRECTIONS';\n  }\n  \n  // Events intent\n  if (lowerMessage.includes('event') || lowerMessage.includes('announcement') || \n      lowerMessage.includes('news') || lowerMessage.includes('upcoming')) {\n    return 'EVENTS_INFO';\n  }\n  \n  // Admission intent\n  if (lowerMessage.includes('admission') || lowerMessage.includes('admit') ||\n      lowerMessage.includes('enroll') || lowerMessage.includes('enrollment') ||\n      lowerMessage.includes('apply') || lowerMessage.includes('application')) {\n    return 'ADMISSION_INFO';\n  }\n  \n  // Timetable intent\n  if (lowerMessage.includes('timetable') || lowerMessage.includes('schedule') ||\n      lowerMessage.includes('class time') || lowerMessage.includes('when is class') ||\n      lowerMessage.includes('what time') || lowerMessage.includes('period')) {\n    return 'TIMETABLE_INFO';\n  }\n  \n  // Exam intent\n  if (lowerMessage.includes('exam') || lowerMessage.includes('examination') ||\n      lowerMessage.includes('test') || lowerMessage.includes('when is exam') ||\n      lowerMessage.includes('exam date') || lowerMessage.includes('exam schedule')) {\n    return 'EXAM_INFO';\n  }\n  \n  return 'GENERAL_INFO';\n}\n\n/**\n * Query staff information from database with in-memory filtering (SQLite friendly)\n */\nexport async function getStaffInfo(query: string): Promise<any[]> {\n  const queryLower = query.toLowerCase().trim();\n  \n  // Department abbreviation mapping\n  const deptMap: { [key: string]: string[] } = {\n    'cse': ['computer science', 'cs'],\n    'cs': ['computer science', 'cse'],\n    'me': ['mechanical', 'mechanical engineering'],\n    'ee': ['electrical', 'electrical engineering'],\n    'ece': ['electronics', 'electronics and communication'],\n  };\n  \n  // Expand department abbreviations\n  const expandedTerms: string[] = [queryLower];\n  for (const [abbr, fullNames] of Object.entries(deptMap)) {\n    if (queryLower.includes(abbr)) {\n      expandedTerms.push(...fullNames);\n    }\n  }\n  \n  // SQLite doesn't support case-insensitive mode, so fetch all active staff\n  const allStaff = await prisma.staff.findMany({\n    where: {\n      status: 'ACTIVE',\n    },\n    take: 50, // Get more to filter\n  });\n  \n  // Filter for case-insensitive matches with expanded terms\n  const filtered = allStaff.filter((staff) => {\n    const nameLower = staff.name.toLowerCase();\n    const deptLower = staff.department.toLowerCase();\n    const desigLower = staff.designation.toLowerCase();\n    const emailLower = (staff.email || '').toLowerCase();\n    \n    // Check if any expanded term matches\n    return expandedTerms.some(term => {\n      // Remove common words for better matching\n      const cleanTerm = term.replace(/\\b(all|the|tell|me|about|names|faculties|faculty)\\b/g, '').trim();\n      if (!cleanTerm) return false;\n      \n      return nameLower.includes(cleanTerm) || \n             deptLower.includes(cleanTerm) || \n             desigLower.includes(cleanTerm) ||\n             emailLower.includes(cleanTerm);\n    });\n  });\n  \n  // If no specific match, return all staff if query is generic\n  if (filtered.length === 0 && (queryLower.includes('all') || queryLower.includes('facult') || queryLower.includes('staff'))) {\n    return allStaff.slice(0, 10);\n  }\n  \n  return filtered.slice(0, 10);\n}\n\n/**\n * Query fee information from database with in-memory case-insensitive filtering\n */\nexport async function getFeeInfo(query: string): Promise<any[]> {\n  const queryLower = query.toLowerCase();\n  \n  // SQLite doesn't support case-insensitive mode, so fetch all fees\n  // and filter in memory\n  const allFees = await prisma.fee.findMany({\n    take: 50, // Get more to filter\n  });\n  \n  // Filter for case-insensitive matches\n  const filtered = allFees.filter((fee) => {\n    const programLower = fee.programName.toLowerCase();\n    const yearLower = fee.academicYear.toLowerCase();\n    const categoryLower = fee.category.toLowerCase();\n    \n    return programLower.includes(queryLower) || \n           yearLower.includes(queryLower) || \n           categoryLower.includes(queryLower);\n  });\n  \n  return filtered.slice(0, 10);\n}\n\n/**\n * Query room/location information from database with in-memory filtering\n */\nexport async function getRoomDirections(query: string): Promise<any | null> {\n  const queryLower = query.toLowerCase();\n  \n  // SQLite doesn't support case-insensitive mode, so fetch all rooms\n  // and filter in memory\n  const allRooms = await prisma.room.findMany({\n    take: 50, // Get more to filter\n  });\n  \n  // Try to find by room code first (exact match preferred)\n  const roomByCode = allRooms.find((room) => \n    room.roomCode.toLowerCase().includes(queryLower)\n  );\n  \n  if (roomByCode) return roomByCode;\n  \n  // Then try building name or floor\n  const roomByBuilding = allRooms.find((room) => \n    room.buildingName.toLowerCase().includes(queryLower) ||\n    room.floor.toLowerCase().includes(queryLower)\n  );\n  \n  return roomByBuilding || null;\n}\n\n/**\n * Query class timetable information from database\n */\nexport async function getClassTimetable(query: string): Promise<any[]> {\n  const queryLower = query.toLowerCase();\n  \n  // Fetch all class timetables\n  const allTimetables = await prisma.classTimetable.findMany({\n    take: 100,\n  });\n  \n  // Filter based on query terms\n  const filtered = allTimetables.filter((tt) => {\n    const programLower = (tt.programName || '').toLowerCase();\n    const semesterLower = (tt.semester || '').toLowerCase();\n    const subjectLower = (tt.subject || '').toLowerCase();\n    const dayLower = (tt.dayOfWeek || '').toLowerCase();\n    const facultyLower = (tt.faculty || '').toLowerCase();\n    const roomLower = (tt.room || '').toLowerCase();\n    \n    // Clean query - remove common words\n    const cleanQuery = queryLower.replace(/\\b(all|the|tell|me|about|show|list|timetable|schedule|class)\\b/g, '').trim();\n    \n    return programLower.includes(cleanQuery) ||\n           semesterLower.includes(cleanQuery) ||\n           subjectLower.includes(cleanQuery) ||\n           dayLower.includes(cleanQuery) ||\n           facultyLower.includes(cleanQuery) ||\n           roomLower.includes(cleanQuery) ||\n           (cleanQuery.length < 3 && queryLower.includes('timetable')); // Generic timetable query\n  });\n  \n  return filtered.slice(0, 20);\n}\n\n/**\n * Query exam timetable information from database\n */\nexport async function getExamTimetable(query: string): Promise<any[]> {\n  const queryLower = query.toLowerCase();\n  \n  // Fetch all exam timetables\n  const allExams = await prisma.examTimetable.findMany({\n    take: 100,\n    orderBy: { examDate: 'asc' },\n  });\n  \n  // Filter based on query terms\n  const filtered = allExams.filter((exam) => {\n    const programLower = (exam.programName || '').toLowerCase();\n    const semesterLower = (exam.semester || '').toLowerCase();\n    const examNameLower = (exam.examName || '').toLowerCase();\n    const subjectLower = (exam.subject || '').toLowerCase();\n    const roomLower = (exam.room || '').toLowerCase();\n    \n    // Clean query - remove common words\n    const cleanQuery = queryLower.replace(/\\b(all|the|tell|me|about|show|list|exam|examination|timetable|schedule)\\b/g, '').trim();\n    \n    return programLower.includes(cleanQuery) ||\n           semesterLower.includes(cleanQuery) ||\n           examNameLower.includes(cleanQuery) ||\n           subjectLower.includes(cleanQuery) ||\n           roomLower.includes(cleanQuery) ||\n           (cleanQuery.length < 3 && (queryLower.includes('exam') || queryLower.includes('timetable')));\n  });\n  \n  return filtered.slice(0, 20);\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 390, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/TECHNOSOFT/Downloads/test-main/PCE_Assistant-main/lib/learningEngine.ts"],"sourcesContent":["import { prisma } from './prisma';\n\n/**\n * Adaptive Learning Engine\n * \n * This module enables the chatbot to learn from admin-provided knowledge base entries\n * and improve its understanding over time.\n */\n\ninterface LearnedPattern {\n  keywords: string[];\n  relatedTerms: string[];\n  knowledgeIds: string[];\n  usageCount: number;\n  lastUsed: Date;\n}\n\ninterface KnowledgeRelationship {\n  sourceId: string;\n  targetId: string;\n  relationshipType: 'similar' | 'related' | 'follows';\n  strength: number;\n}\n\n// In-memory cache for learned patterns (could be persisted to DB in future)\nlet learnedPatterns: Map<string, LearnedPattern> = new Map();\nlet knowledgeRelationships: Map<string, KnowledgeRelationship[]> = new Map();\nlet dynamicSynonyms: Map<string, Set<string>> = new Map();\n\n/**\n * Extract keywords and important terms from knowledge base entry\n */\nfunction extractKeywords(text: string, name: string): string[] {\n  const combined = `${name} ${text}`.toLowerCase();\n  \n  // Remove common stop words\n  const stopWords = new Set([\n    'the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with',\n    'by', 'from', 'as', 'is', 'was', 'are', 'were', 'been', 'be', 'have', 'has', 'had',\n    'this', 'that', 'these', 'those', 'i', 'you', 'he', 'she', 'it', 'we', 'they',\n    'what', 'which', 'who', 'where', 'when', 'why', 'how', 'all', 'each', 'every',\n    'both', 'few', 'more', 'most', 'other', 'some', 'such', 'no', 'nor', 'not',\n    'only', 'own', 'same', 'so', 'than', 'too', 'very', 'just', 'about', 'into',\n    'can', 'will', 'would', 'could', 'should', 'may', 'might', 'must'\n  ]);\n  \n  // Extract meaningful words (3+ characters, not stop words)\n  const words = combined\n    .replace(/[^\\w\\s]/g, ' ')\n    .split(/\\s+/)\n    .filter(w => w.length >= 3 && !stopWords.has(w));\n  \n  // Count word frequency\n  const wordFreq = new Map<string, number>();\n  words.forEach(word => {\n    wordFreq.set(word, (wordFreq.get(word) || 0) + 1);\n  });\n  \n  // Return top keywords (words that appear multiple times or are in the name)\n  const nameWords = new Set(name.toLowerCase().split(/\\s+/).filter(w => w.length >= 3));\n  const keywords = Array.from(wordFreq.entries())\n    .filter(([word, count]) => count >= 2 || nameWords.has(word))\n    .sort((a, b) => b[1] - a[1])\n    .slice(0, 15)\n    .map(([word]) => word);\n  \n  return keywords;\n}\n\n/**\n * Find related terms by analyzing knowledge base content\n */\nfunction findRelatedTerms(knowledgeEntries: any[]): Map<string, Set<string>> {\n  const termCooccurrence = new Map<string, Map<string, number>>();\n  \n  knowledgeEntries.forEach(entry => {\n    const keywords = extractKeywords(entry.text, entry.name);\n    \n    // Build co-occurrence matrix\n    keywords.forEach((word1, i) => {\n      if (!termCooccurrence.has(word1)) {\n        termCooccurrence.set(word1, new Map());\n      }\n      const cooccur = termCooccurrence.get(word1)!;\n      \n      keywords.forEach((word2, j) => {\n        if (i !== j) {\n          cooccur.set(word2, (cooccur.get(word2) || 0) + 1);\n        }\n      });\n    });\n  });\n  \n  // Build synonym/related term map\n  const relatedTerms = new Map<string, Set<string>>();\n  const threshold = 2; // Minimum co-occurrence to consider terms related\n  \n  termCooccurrence.forEach((cooccur, term) => {\n    const related = new Set<string>();\n    cooccur.forEach((count, otherTerm) => {\n      if (count >= threshold) {\n        related.add(otherTerm);\n        // Also add reverse relationship\n        if (!relatedTerms.has(otherTerm)) {\n          relatedTerms.set(otherTerm, new Set());\n        }\n        relatedTerms.get(otherTerm)!.add(term);\n      }\n    });\n    if (related.size > 0) {\n      relatedTerms.set(term, related);\n    }\n  });\n  \n  return relatedTerms;\n}\n\n/**\n * Build relationships between knowledge entries\n */\nfunction buildKnowledgeRelationships(knowledgeEntries: any[]): Map<string, KnowledgeRelationship[]> {\n  const relationships = new Map<string, KnowledgeRelationship[]>();\n  \n  knowledgeEntries.forEach((entry1, i) => {\n    const entry1Keywords = new Set(extractKeywords(entry1.text, entry1.name));\n    const entry1Relations: KnowledgeRelationship[] = [];\n    \n    knowledgeEntries.forEach((entry2, j) => {\n      if (i === j) return;\n      \n      const entry2Keywords = new Set(extractKeywords(entry2.text, entry2.name));\n      \n      // Calculate similarity (Jaccard similarity)\n      const intersection = new Set([...entry1Keywords].filter(x => entry2Keywords.has(x)));\n      const union = new Set([...entry1Keywords, ...entry2Keywords]);\n      const similarity = intersection.size / union.size;\n      \n      if (similarity > 0.2) { // 20% similarity threshold\n        entry1Relations.push({\n          sourceId: entry1.id,\n          targetId: entry2.id,\n          relationshipType: similarity > 0.5 ? 'similar' : 'related',\n          strength: similarity,\n        });\n      }\n    });\n    \n    // Sort by strength and keep top 5\n    entry1Relations.sort((a, b) => b.strength - a.strength);\n    relationships.set(entry1.id, entry1Relations.slice(0, 5));\n  });\n  \n  return relationships;\n}\n\n/**\n * Learn from all knowledge base entries\n * This should be called periodically or when new knowledge is added\n */\nexport async function learnFromKnowledgeBase() {\n  try {\n    console.log('ðŸ§  Learning from knowledge base...');\n    \n    // Fetch all knowledge entries\n    const allKnowledge = await prisma.knowledge.findMany({\n      orderBy: { updatedAt: 'desc' },\n    });\n    \n    if (allKnowledge.length === 0) {\n      console.log('No knowledge entries to learn from');\n      return;\n    }\n    \n    // Extract patterns for each knowledge entry\n    const newPatterns = new Map<string, LearnedPattern>();\n    \n    allKnowledge.forEach(entry => {\n      const keywords = extractKeywords(entry.text, entry.name);\n      const type = entry.type.toLowerCase();\n      \n      // Create or update pattern\n      const patternKey = `${type}:${entry.name.toLowerCase()}`;\n      const existingPattern = learnedPatterns.get(patternKey);\n      \n      newPatterns.set(patternKey, {\n        keywords,\n        relatedTerms: [],\n        knowledgeIds: existingPattern \n          ? [...existingPattern.knowledgeIds, entry.id]\n          : [entry.id],\n        usageCount: existingPattern?.usageCount || 0,\n        lastUsed: existingPattern?.lastUsed || new Date(),\n      });\n    });\n    \n    // Find related terms across all knowledge\n    const relatedTerms = findRelatedTerms(allKnowledge);\n    dynamicSynonyms = relatedTerms;\n    \n    // Build knowledge relationships\n    const relationships = buildKnowledgeRelationships(allKnowledge);\n    knowledgeRelationships = relationships;\n    \n    // Update learned patterns\n    learnedPatterns = newPatterns;\n    \n    console.log(`âœ… Learned from ${allKnowledge.length} knowledge entries`);\n    console.log(`   - Extracted ${newPatterns.size} patterns`);\n    console.log(`   - Found ${relatedTerms.size} term relationships`);\n    console.log(`   - Built ${Array.from(relationships.values()).flat().length} knowledge relationships`);\n    \n    return {\n      patternsLearned: newPatterns.size,\n      relationshipsFound: Array.from(relationships.values()).flat().length,\n      termsLearned: relatedTerms.size,\n    };\n  } catch (error) {\n    console.error('Error learning from knowledge base:', error);\n    return null;\n  }\n}\n\n/**\n * Get dynamically learned synonyms for a term\n */\nexport function getLearnedSynonyms(term: string): string[] {\n  const lowerTerm = term.toLowerCase();\n  const synonyms = dynamicSynonyms.get(lowerTerm);\n  return synonyms ? Array.from(synonyms) : [];\n}\n\n/**\n * Get related knowledge entries based on learned relationships\n */\nexport function getRelatedKnowledge(knowledgeId: string, limit = 3): string[] {\n  const relationships = knowledgeRelationships.get(knowledgeId);\n  if (!relationships || relationships.length === 0) {\n    return [];\n  }\n  \n  // Sort by strength and return top related IDs\n  return relationships\n    .sort((a, b) => b.strength - a.strength)\n    .slice(0, limit)\n    .map(rel => rel.targetId);\n}\n\n/**\n * Update usage statistics when knowledge is used\n */\nexport function recordKnowledgeUsage(knowledgeId: string, query: string) {\n  // Find matching pattern\n  for (const [patternKey, pattern] of learnedPatterns.entries()) {\n    if (pattern.knowledgeIds.includes(knowledgeId)) {\n      pattern.usageCount++;\n      pattern.lastUsed = new Date();\n      \n      // Extract query terms and add to related terms if not already present\n      const queryWords = query.toLowerCase().split(/\\s+/).filter(w => w.length >= 3);\n      queryWords.forEach(word => {\n        if (!pattern.relatedTerms.includes(word)) {\n          pattern.relatedTerms.push(word);\n        }\n      });\n      \n      break;\n    }\n  }\n}\n\n/**\n * Get learned patterns for a query\n */\nexport function getLearnedPatterns(query: string): LearnedPattern[] {\n  const queryLower = query.toLowerCase();\n  const queryWords = queryLower.split(/\\s+/).filter(w => w.length >= 3);\n  \n  const matchingPatterns: LearnedPattern[] = [];\n  \n  learnedPatterns.forEach((pattern, key) => {\n    // Check if query matches pattern keywords or related terms\n    const matches = pattern.keywords.some(kw => queryWords.some(qw => qw.includes(kw) || kw.includes(qw))) ||\n                   pattern.relatedTerms.some(rt => queryWords.some(qw => qw.includes(rt) || rt.includes(qw)));\n    \n    if (matches) {\n      matchingPatterns.push(pattern);\n    }\n  });\n  \n  // Sort by usage count (more used = more relevant)\n  matchingPatterns.sort((a, b) => b.usageCount - a.usageCount);\n  \n  return matchingPatterns;\n}\n\n// Lazy initialization flag\nlet isInitialized = false;\nlet initializationPromise: Promise<any> | null = null;\n\n/**\n * Initialize learning on startup (lazy - only runs once)\n */\nexport async function initializeLearning() {\n  if (isInitialized) {\n    return;\n  }\n  \n  if (initializationPromise) {\n    return initializationPromise;\n  }\n  \n  initializationPromise = (async () => {\n    try {\n      console.log('ðŸš€ Initializing adaptive learning engine...');\n      await learnFromKnowledgeBase();\n      isInitialized = true;\n      console.log('âœ… Learning engine ready');\n    } catch (error) {\n      console.error('Error initializing learning engine:', error);\n      initializationPromise = null; // Allow retry\n    }\n  })();\n  \n  return initializationPromise;\n}\n\n/**\n * Ensure learning is initialized (called automatically when needed)\n */\nexport async function ensureInitialized() {\n  if (!isInitialized && !initializationPromise) {\n    await initializeLearning();\n  }\n  return initializationPromise;\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 713, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/TECHNOSOFT/Downloads/test-main/PCE_Assistant-main/lib/knowledge.ts"],"sourcesContent":["import { prisma } from './prisma';\nimport { \n  getLearnedSynonyms, \n  getRelatedKnowledge, \n  recordKnowledgeUsage,\n  getLearnedPatterns,\n  ensureInitialized \n} from './learningEngine';\n\n// Common stop words to ignore in search\nconst STOP_WORDS = new Set([\n  'the', 'a', 'an', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with',\n  'by', 'from', 'as', 'is', 'was', 'are', 'were', 'been', 'be', 'have', 'has', 'had',\n  'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'must',\n  'can', 'this', 'that', 'these', 'those', 'i', 'you', 'he', 'she', 'it', 'we', 'they',\n  'what', 'which', 'who', 'whom', 'whose', 'where', 'when', 'why', 'how', 'all', 'each',\n  'every', 'both', 'few', 'more', 'most', 'other', 'some', 'such', 'no', 'nor', 'not',\n  'only', 'own', 'same', 'so', 'than', 'too', 'very', 'just', 'about', 'into', 'through',\n  'during', 'before', 'after', 'above', 'below', 'up', 'down', 'out', 'off', 'over',\n  'under', 'again', 'further', 'then', 'once', 'here', 'there', 'when', 'where', 'why',\n  'how', 'all', 'any', 'both', 'each', 'few', 'more', 'most', 'other', 'some', 'such',\n  'no', 'nor', 'not', 'only', 'own', 'same', 'so', 'than', 'too', 'very', 'can', 'will',\n  'just', 'don', 'should', 'now', 'hi', 'hello', 'hey', 'tell', 'me', 'please', 'thanks'\n]);\n\n// Synonym mapping for better matching\nconst SYNONYMS: { [key: string]: string[] } = {\n  'admission': ['admit', 'enroll', 'enrollment', 'apply', 'application', 'entry'],\n  'fee': ['fees', 'tuition', 'payment', 'cost', 'price', 'charges', 'amount'],\n  'faculty': ['faculties', 'teacher', 'teachers', 'professor', 'professors', 'staff', 'hod'],\n  'department': ['dept', 'branch', 'program', 'course'],\n  'room': ['classroom', 'lab', 'laboratory', 'hall', 'office'],\n  'cse': ['computer science', 'cs', 'computer'],\n  'me': ['mechanical', 'mechanical engineering'],\n  'ee': ['electrical', 'electrical engineering'],\n  'location': ['where', 'place', 'address', 'directions'],\n  'contact': ['phone', 'email', 'reach', 'call'],\n};\n\n/**\n * Expand query with synonyms for better matching\n * Now includes dynamically learned synonyms from knowledge base\n */\nfunction expandQuery(query: string): string[] {\n  const words = query.toLowerCase().split(/\\s+/);\n  const expanded: string[] = [query.toLowerCase()];\n  \n  words.forEach(word => {\n    // Add original word\n    if (word.length > 2 && !STOP_WORDS.has(word)) {\n      expanded.push(word);\n    }\n    \n    // Add static synonyms\n    for (const [key, synonyms] of Object.entries(SYNONYMS)) {\n      if (word === key || synonyms.includes(word)) {\n        expanded.push(...synonyms);\n        expanded.push(key);\n      }\n    }\n    \n    // Add dynamically learned synonyms from knowledge base\n    const learnedSynonyms = getLearnedSynonyms(word);\n    if (learnedSynonyms.length > 0) {\n      expanded.push(...learnedSynonyms);\n    }\n  });\n  \n  return [...new Set(expanded)]; // Remove duplicates\n}\n\n/**\n * Calculate relevance score for a knowledge entry\n */\nfunction calculateRelevance(item: any, queryWords: string[], expandedTerms: string[]): number {\n  const textLower = item.text.toLowerCase();\n  const nameLower = item.name.toLowerCase();\n  const sourceLower = item.source.toLowerCase();\n  const typeLower = item.type.toLowerCase();\n  const combinedText = `${nameLower} ${textLower} ${sourceLower} ${typeLower}`;\n  \n  let score = 0;\n  let exactMatches = 0;\n  let wordMatches = 0;\n  \n  // Check for exact phrase match (highest priority)\n  const exactPhrase = queryWords.join(' ');\n  if (combinedText.includes(exactPhrase)) {\n    score += 50;\n    exactMatches++;\n  }\n  \n  // Check each query word\n  queryWords.forEach(word => {\n    if (word.length < 2) return;\n    \n    // Exact word match in name (highest weight)\n    if (nameLower.includes(word)) {\n      score += 10;\n      wordMatches++;\n    }\n    \n    // Exact word match in text\n    const wordCount = (textLower.match(new RegExp(`\\\\b${word}\\\\b`, 'g')) || []).length;\n    score += wordCount * 3;\n    if (wordCount > 0) wordMatches++;\n    \n    // Match in source/type\n    if (sourceLower.includes(word) || typeLower.includes(word)) {\n      score += 2;\n    }\n  });\n  \n  // Check expanded terms (synonyms)\n  expandedTerms.forEach(term => {\n    if (term.length < 2) return;\n    if (combinedText.includes(term)) {\n      score += 1;\n    }\n  });\n  \n  // Boost score for recent entries (admin-provided content is usually recent)\n  const daysSinceUpdate = (Date.now() - new Date(item.updatedAt).getTime()) / (1000 * 60 * 60 * 24);\n  if (daysSinceUpdate < 30) {\n    score += 5; // Recent content gets a boost\n  }\n  \n  // Boost score if multiple words match\n  if (wordMatches >= queryWords.length * 0.5) {\n    score += 10; // Good overall match\n  }\n  \n  return score;\n}\n\nexport async function searchKnowledge(query: string, limit = 5) {\n  // Ensure learning engine is initialized\n  await ensureInitialized();\n  \n  if (!query || !query.trim()) {\n    // Return recent knowledge entries for generic queries\n    const results = await prisma.knowledge.findMany({\n      orderBy: { updatedAt: 'desc' },\n      take: limit,\n    });\n    return results;\n  }\n\n  // Clean and expand query\n  const cleanQuery = query.toLowerCase()\n    .replace(/[^\\w\\s]/g, ' ') // Remove punctuation\n    .split(/\\s+/)\n    .filter(w => w.length > 0 && !STOP_WORDS.has(w))\n    .join(' ')\n    .trim();\n  \n  if (!cleanQuery) {\n    // If query is too generic, get recent knowledge entries\n    const results = await prisma.knowledge.findMany({\n      orderBy: { updatedAt: 'desc' },\n      take: limit,\n    });\n    return results;\n  }\n\n  // Get all knowledge entries for comprehensive search\n  const allKnowledge = await prisma.knowledge.findMany({\n    orderBy: { updatedAt: 'desc' },\n    take: 200, // Get more entries for better matching\n  });\n\n  // Extract meaningful words from query\n  const queryWords = cleanQuery.split(/\\s+/).filter(w => w.length > 2);\n  const expandedTerms = expandQuery(cleanQuery);\n\n  // Calculate relevance for each entry\n  const scored = allKnowledge.map(item => ({\n    ...item,\n    score: calculateRelevance(item, queryWords, expandedTerms),\n  }));\n\n  // Filter out entries with zero score and sort by relevance\n  const relevant = scored\n    .filter(item => item.score > 0)\n    .sort((a, b) => {\n      // Sort by score (descending), then by recency\n      if (b.score !== a.score) {\n        return b.score - a.score;\n      }\n      return new Date(b.updatedAt).getTime() - new Date(a.updatedAt).getTime();\n    })\n    .slice(0, limit)\n    .map(({ score, ...item }) => item);\n\n  // If no relevant results, try using learned patterns\n  if (relevant.length === 0) {\n    const learnedPatterns = getLearnedPatterns(query);\n    if (learnedPatterns.length > 0) {\n      // Get knowledge IDs from learned patterns\n      const patternKnowledgeIds = learnedPatterns\n        .flatMap(p => p.knowledgeIds)\n        .slice(0, limit);\n      \n      const patternResults = allKnowledge.filter(k => \n        patternKnowledgeIds.includes(k.id)\n      );\n      \n      if (patternResults.length > 0) {\n        return patternResults;\n      }\n    }\n    \n    // Final fallback: return recent entries\n    return allKnowledge.slice(0, limit);\n  }\n\n  // Record usage for learning\n  relevant.forEach(item => {\n    recordKnowledgeUsage(item.id, query);\n  });\n\n  // Add related knowledge entries based on learned relationships\n  const enhancedResults = [...relevant];\n  if (relevant.length > 0 && enhancedResults.length < limit) {\n    const topResult = relevant[0];\n    const relatedIds = getRelatedKnowledge(topResult.id, limit - enhancedResults.length);\n    const relatedEntries = allKnowledge.filter(k => \n      relatedIds.includes(k.id) && !enhancedResults.some(r => r.id === k.id)\n    );\n    enhancedResults.push(...relatedEntries);\n  }\n\n  return enhancedResults.slice(0, limit);\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1144, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/TECHNOSOFT/Downloads/test-main/PCE_Assistant-main/lib/groqLlmService.ts"],"sourcesContent":["import Groq from 'groq-sdk';\n\nexport type LlmContext = {\n  intent: string;\n  userMessage: string;\n  data?: any; // structured data from DB / knowledge search\n};\n\nconst groqApiKey = process.env.GROQ_API_KEY;\n\nif (!groqApiKey) {\n  console.warn('GROQ_API_KEY is not set. LLM responses will not be available.');\n}\n\nconst groq = groqApiKey ? new Groq({ apiKey: groqApiKey }) : null;\n\nexport async function callGroqLLM(\n  ctx: LlmContext\n): Promise<{ answer: string; sources?: any[] }> {\n  const { intent, userMessage, data } = ctx;\n\n  // Prioritize knowledge base content\n  const hasKnowledge = data?.knowledge && Array.isArray(data.knowledge) && data.knowledge.length > 0;\n  const hasStaff = data?.staff && Array.isArray(data.staff) && data.staff.length > 0;\n  const hasFees = data?.fees && Array.isArray(data.fees) && data.fees.length > 0;\n  const hasRoom = data?.room;\n  const hasClassTimetable = data?.classTimetable && Array.isArray(data.classTimetable) && data.classTimetable.length > 0;\n  const hasExamTimetable = data?.examTimetable && Array.isArray(data.examTimetable) && data.examTimetable.length > 0;\n\n  // Format knowledge base entries for better understanding\n  let knowledgeSection = '';\n  if (hasKnowledge) {\n    knowledgeSection = `\nðŸ“š KNOWLEDGE BASE CONTENT (Admin-provided information - USE THIS AS PRIMARY SOURCE):\n${data.knowledge.map((k: any, idx: number) => `\nEntry ${idx + 1}:\n- Title: ${k.name || 'Untitled'}\n- Type: ${k.type || 'General'}\n- Source: ${k.source || 'Admin'}\n- Content: ${k.text || ''}\n${k.imageUrl ? `- Image Available: Yes (image will be displayed automatically - DO NOT include the URL in your response)` : ''}\n${k.imageDescription ? `- Image Description: ${k.imageDescription}` : ''}\n`).join('\\n')}\n\nCRITICAL: Use ALL information from knowledge base EXACTLY as provided. This includes names, titles, designations, image descriptions, and any other details. DO NOT modify, add, or remove any information. If a name in the knowledge base includes \"Dr\", \"Mr\", \"Mrs\", \"Ms\", or any other title, use it exactly. If it doesn't include a title, DO NOT add one.\n\nIMAGES - CRITICAL RULES:\n- When an image is available in the knowledge base, you can mention it naturally in your response\n- Example: \"Here's the information, and I've included an image below that shows [description].\"\n- Use the image description to provide context about what the image contains\n- The image will be displayed automatically to the user - you do NOT need to include the image URL or path\n- DO NOT include image URLs, file paths, or image file names in your response (like \"/uploads/knowledge/...\" or \".jpg\" files)\n- DO NOT write \"Here's the image of...\" followed by a URL or path\n- Simply mention that an image is available and describe what it shows - the system will display it automatically\n`;\n  }\n\n  // Format other data - use exact data without modifications\n  let staffSection = '';\n  if (hasStaff) {\n    staffSection = `\nðŸ‘¥ STAFF INFORMATION (USE EXACTLY AS PROVIDED - DO NOT ADD TITLES):\n${data.staff.map((staff: any) => ({\n  name: staff.name || 'Unknown', // Use name EXACTLY as stored - includes title if present\n  department: staff.department || 'Not specified',\n  designation: staff.designation || 'Not specified',\n  email: staff.email || 'Not available',\n  phone: staff.phone || 'Not available',\n})).map((s: any, idx: number) => `Staff ${idx + 1}: ${JSON.stringify(s, null, 2)}`).join('\\n\\n')}\n\nCRITICAL: Use names EXACTLY as shown above. If a name includes \"Dr\", \"Mr\", \"Mrs\", \"Ms\", etc., use it. If it doesn't, DO NOT add any title.\n`;\n  }\n\n  let feesSection = '';\n  if (hasFees) {\n    feesSection = `\nðŸ’° FEE INFORMATION:\n${JSON.stringify(data.fees, null, 2)}\n`;\n  }\n\n  let roomSection = '';\n  if (hasRoom) {\n    roomSection = `\nðŸ“ ROOM/LOCATION INFORMATION:\n${JSON.stringify(data.room, null, 2)}\n`;\n  }\n\n  let classTimetableSection = '';\n  if (hasClassTimetable) {\n    classTimetableSection = `\nðŸ“… CLASS TIMETABLE INFORMATION (USE EXACTLY AS PROVIDED):\n${data.classTimetable.map((tt: any) => ({\n  program: tt.programName || 'Not specified',\n  semester: tt.semester || 'Not specified',\n  day: tt.dayOfWeek || 'Not specified',\n  period: tt.period || 'Not specified',\n  subject: tt.subject || 'Not specified',\n  faculty: tt.faculty || 'Not assigned', // Use faculty name EXACTLY as stored - includes title if present\n  room: tt.room || 'Not assigned',\n})).map((tt: any, idx: number) => `Class ${idx + 1}: ${JSON.stringify(tt, null, 2)}`).join('\\n\\n')}\n\nCRITICAL: Use faculty names EXACTLY as shown. If a faculty name includes \"Dr\" or any title, use it. If it doesn't, DO NOT add any title.\n`;\n  }\n\n  let examTimetableSection = '';\n  if (hasExamTimetable) {\n    examTimetableSection = `\nðŸ“ EXAM TIMETABLE INFORMATION (USE EXACTLY AS PROVIDED):\n${data.examTimetable.map((exam: any) => ({\n  program: exam.programName || 'Not specified',\n  semester: exam.semester || 'Not specified',\n  examName: exam.examName || 'Not specified',\n  subject: exam.subject || 'Not specified',\n  date: new Date(exam.examDate).toLocaleDateString(),\n  time: `${exam.startTime || 'TBA'} - ${exam.endTime || 'TBA'}`,\n  room: exam.room || 'Not assigned',\n})).map((exam: any, idx: number) => `Exam ${idx + 1}: ${JSON.stringify(exam, null, 2)}`).join('\\n\\n')}\n`;\n  }\n\n  // Detect if this is a simple greeting\n  const isGreeting = intent === 'GREETING';\n  const hasData = hasKnowledge || hasStaff || hasFees || hasRoom || hasClassTimetable || hasExamTimetable;\n\n  const systemPrompt = `\nYou are a friendly and helpful campus assistant chatbot for Providence College of Engineering (PCE).\nYou're here to help students, parents, and visitors with information about the college.\n\nðŸŽ¯ IMPORTANT RULES:\n\n${isGreeting ? `\n**FOR GREETINGS (like \"hi\", \"hello\", \"hey\"):**\n- Respond naturally and conversationally, like a real person would\n- Keep it SHORT and FRIENDLY - just 1-2 sentences\n- Don't overwhelm with information - just greet them back\n- Examples of good responses:\n  * \"Hi there! How can I help you today?\"\n  * \"Hello! What would you like to know about PCE?\"\n  * \"Hey! I'm here to help with any questions about the college. What can I help you with?\"\n- DO NOT list features, capabilities, or information unless asked\n- Just be warm and welcoming, then wait for their actual question\n` : `\n**FOR ACTUAL QUESTIONS:**\n\n1. KNOWLEDGE BASE PRIORITY:\n   - If KNOWLEDGE BASE CONTENT is provided, it contains information directly added by administrators\n   - ALWAYS prioritize and use knowledge base content as your PRIMARY source\n   - Knowledge base content is the most accurate and up-to-date information\n   - When knowledge base content answers the question, use it EXACTLY and explain it clearly\n\n2. RESPONSE STYLE:\n   - Be conversational and human-like - talk like a friendly person, not a robot\n   - Use natural language, contractions (I'm, you're, don't), and casual expressions when appropriate\n   - Provide clear, structured information when needed\n   - Use bullet points or numbered lists ONLY when listing multiple items\n   - Be specific with details (names, amounts, locations, etc.) when relevant\n   - Don't over-explain - give just enough information to answer the question\n\n3. DATA USAGE - CRITICAL ACCURACY RULES:\n   \n   **NAMES AND TITLES (MOST IMPORTANT):**\n   - Use ALL names EXACTLY as they appear in the data sources\n   - DO NOT add titles like \"Dr\", \"Mr\", \"Mrs\", \"Ms\", \"Prof\", \"Professor\" unless they are already in the name field\n   - If a name in the database is \"John Smith\", say \"John Smith\" - NOT \"Dr. John Smith\"\n   - If a name in the database is \"Dr. Sarah Johnson\", say \"Dr. Sarah Johnson\" - use it exactly\n   - This applies to: Staff names, Faculty names, Any person names from knowledge base, Class timetable faculty, All other sources\n   \n   **STAFF INFORMATION:**\n   - Use staff names EXACTLY as provided - includes title if present in database\n   - Use department and designation exactly as stored\n   - Use contact information (email, phone) exactly as provided\n   \n   **FEE INFORMATION:**\n   - Use amounts exactly as shown (with currency)\n   - Use program names, categories, and academic years exactly as stored\n   - Don't round or modify amounts\n   \n   **ROOM INFORMATION:**\n   - Use room codes exactly as stored (e.g., \"CS-101\", not \"CS101\" or \"cs-101\")\n   - Use building names and floor information exactly as provided\n   - Use directions text exactly as stored\n   \n   **CLASS TIMETABLE:**\n   - Use program names, semesters, days, periods exactly as stored\n   - Use subject names exactly as provided\n   - Use faculty names EXACTLY - includes title if present, don't add if not present\n   - Use room codes exactly as stored\n   \n   **EXAM TIMETABLE:**\n   - Use exam names, subjects, dates, times exactly as stored\n   - Use program and semester exactly as provided\n   - Use room codes exactly as stored\n   \n   **KNOWLEDGE BASE:**\n   - Use ALL content EXACTLY as provided by administrators\n   - This is the PRIMARY source - use it verbatim when it answers the question\n   - Don't modify, summarize, or paraphrase knowledge base content\n   - Use names, titles, and all details exactly as written\n   \n   - Only include data that's actually relevant to the question\n\n4. CLARITY AND UNDERSTANDING:\n   - Write in simple, easy-to-understand language\n   - Avoid jargon unless necessary, and explain it if used\n   - Break down complex information into digestible parts\n   - Use examples when helpful\n   - Format numbers, dates, and important details clearly\n\n5. DEPARTMENT ABBREVIATIONS:\n   - CSE = Computer Science and Engineering\n   - ME = Mechanical Engineering\n   - EE = Electrical Engineering\n   - ECE = Electronics and Communication Engineering\n\n6. WHEN INFORMATION IS MISSING:\n   - If you have partial information, provide what you CAN tell them\n   - Be honest about what you don't know\n   - Suggest contacting the administration office for complete details\n   - Provide contact information if available in the knowledge base\n\n7. TONE AND PERSONALITY:\n   - Be warm, friendly, and approachable - like talking to a helpful friend\n   - Show genuine interest in helping\n   - Be patient and clear\n   - Use natural, conversational language\n   - Vary your responses - don't sound repetitive or robotic\n   - Match the user's energy level (if they're casual, be casual; if formal, be professional)\n\n8. FORMATTING (IMPORTANT):\n   - Use double line breaks (\\n\\n) to separate paragraphs for better readability\n   - Use single line breaks (\\n) within paragraphs only when necessary\n   - When listing items, use bullet points with \"- \" or \"* \" at the start of each line\n   - Keep paragraphs short (2-4 sentences max) for easy reading\n   - Add spacing between different topics or sections\n   - Format numbers, dates, and important details clearly\n   - Example format:\n     \"Here's the information you need:\n\n     The library hours are:\n     - Monday to Friday: 8 AM to 8 PM\n     - Saturday: 9 AM to 5 PM\n     - Sunday: Closed\n\n     For more details, you can contact the library office.\"\n`}\n\nCurrent intent detected: ${intent}\n${hasData ? 'Data is available to answer the question.' : 'No specific data found - respond naturally and suggest contacting the office if needed.'}\n\nRemember: Be HUMAN, be FRIENDLY, be HELPFUL - but don't overwhelm with information unless asked!\n  `.trim();\n\n  const userPrompt = isGreeting ? `\nUser just said: \"${userMessage}\"\n\nThis is a simple greeting. Respond naturally and briefly - just greet them back and ask how you can help. \nKeep it short (1-2 sentences max). Don't provide any information unless they ask for it.\n  `.trim() : `\nUser's Question:\n\"${userMessage}\"\n\n${knowledgeSection}\n\n${staffSection}\n\n${feesSection}\n\n${roomSection}\n\n${classTimetableSection}\n\n${examTimetableSection}\n\n${!hasKnowledge && !hasStaff && !hasFees && !hasRoom && !hasClassTimetable && !hasExamTimetable ? 'No specific data found in database. Respond naturally and suggest contacting the office for specific details.' : ''}\n\nINSTRUCTIONS:\n- Answer the user's question naturally and conversationally\n- If knowledge base content is available, use it as your PRIMARY source and use it EXACTLY\n- Be human-like and friendly - talk like a real person would\n- Don't be overly formal or robotic\n\n**CRITICAL ACCURACY REQUIREMENTS:**\n- Use ALL names EXACTLY as they appear in the data sources - NO modifications\n- DO NOT add titles (Dr, Mr, Mrs, Ms, Prof, Professor) unless already in the name field\n- Use all data (amounts, dates, codes, names) EXACTLY as stored in database/knowledge base\n- Knowledge base content should be used verbatim when it answers the question\n- Staff names: Use exactly as stored (with title if present, without if not)\n- Faculty names in timetables: Use exactly as stored (with title if present, without if not)\n- Room codes: Use exactly as stored (e.g., \"CS-101\" not \"cs-101\" or \"CS101\")\n- Fee amounts: Use exactly as stored with currency\n- Dates and times: Use exactly as formatted in the data\n\n**IMAGE HANDLING - VERY IMPORTANT:**\n- When an image is available from the knowledge base, mention it naturally but DO NOT include image URLs, file paths, or file names\n- DO NOT write things like \"/uploads/knowledge/...\" or \".jpg\" or any file paths\n- DO NOT write \"Here's the image of...\" followed by a URL\n- Simply say something like \"Here's the information, and I've included an image below that shows [description]\"\n- The image will be displayed automatically by the system - you don't need to reference the file path\n- Focus on describing what the image shows, not where it's stored\n\n- Only provide the information that's relevant to their question\n- Keep it clear and easy to understand\n- Format timetable data clearly with day, time, subject, faculty (exact name), and room information\n  `.trim();\n\n  if (!groq) {\n    return {\n      answer:\n        'LLM is not configured. Please set GROQ_API_KEY on the server to enable responses.',\n      sources: Array.isArray(data?.sources) ? data.sources : [],\n    };\n  }\n\n  const model = process.env.GROQ_MODEL || 'llama-3.1-8b-instant';\n\n  try {\n    const completion = await groq.chat.completions.create({\n      model,\n      messages: [\n        { role: 'system', content: systemPrompt },\n        { role: 'user', content: userPrompt },\n      ],\n    });\n\n    const answer =\n      completion.choices?.[0]?.message?.content ??\n      \"Sorry, I couldn't generate a response.\";\n\n    return {\n      answer,\n      sources: Array.isArray(data?.sources) ? data.sources : [],\n    };\n  } catch (error: any) {\n    console.error('Groq LLM error:', error);\n    const friendly =\n      error?.error?.message ||\n      error?.message ||\n      'I am having trouble connecting to the service right now. Please try again later or contact the administration office.';\n    return {\n      answer: friendly,\n      sources: Array.isArray(data?.sources) ? data.sources : [],\n    };\n  }\n}\n\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1476, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/TECHNOSOFT/Downloads/test-main/PCE_Assistant-main/app/api/chat/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { prisma } from '@/lib/prisma';\nimport { detectIntent, getStaffInfo, getFeeInfo, getRoomDirections, getClassTimetable, getExamTimetable } from '@/lib/chatHelpers';\nimport { searchKnowledge } from '@/lib/knowledge';\nimport { callGroqLLM } from '@/lib/groqLlmService';\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { message, conversationId } = body;\n\n    if (!message || typeof message !== 'string') {\n      return NextResponse.json(\n        { error: 'Message is required' },\n        { status: 400 }\n      );\n    }\n\n    // Detect intent\n    const intent = detectIntent(message);\n     const isSimpleGreeting = intent === 'GREETING';\n\n    // Query database based on intent\n    const data: any = {};\n    let knowledge: any[] = [];\n    \n    // For simple greetings, skip all data fetching - just respond naturally\n    if (!isSimpleGreeting) {\n      // Always try to get relevant data based on intent\n      if (intent === 'FEES_INFO') {\n        data.fees = await getFeeInfo(message);\n      }\n      if (intent === 'STAFF_INFO') {\n        data.staff = await getStaffInfo(message);\n      }\n      if (intent === 'DIRECTIONS') {\n        data.room = await getRoomDirections(message);\n      }\n      if (intent === 'TIMETABLE_INFO') {\n        data.classTimetable = await getClassTimetable(message);\n      }\n      if (intent === 'EXAM_INFO') {\n        data.examTimetable = await getExamTimetable(message);\n      }\n      if (intent === 'ADMISSION_INFO' || intent === 'GENERAL_INFO') {\n        // For admission and general queries, try to get relevant data from all sources\n        const msgLower = message.toLowerCase();\n        \n        // Staff/Faculty queries\n        if (msgLower.includes('facult') || msgLower.includes('staff') || \n            msgLower.includes('teacher') || msgLower.includes('professor') ||\n            msgLower.includes('hod') || msgLower.includes('head of department')) {\n          data.staff = await getStaffInfo(message);\n        }\n        \n        // Fee queries\n        if (msgLower.includes('fee') || msgLower.includes('cost') || \n            msgLower.includes('tuition') || msgLower.includes('payment') ||\n            msgLower.includes('price') || msgLower.includes('charges')) {\n          data.fees = await getFeeInfo(message);\n        }\n        \n        // Room/Location queries\n        if (msgLower.includes('room') || msgLower.includes('location') || \n            msgLower.includes('where') || msgLower.includes('building') ||\n            msgLower.includes('directions') || msgLower.includes('find')) {\n          data.room = await getRoomDirections(message);\n        }\n        \n        // Class timetable queries\n        if (msgLower.includes('timetable') || msgLower.includes('schedule') || \n            msgLower.includes('class time') || msgLower.includes('when is class') ||\n            msgLower.includes('period') || msgLower.includes('subject') ||\n            msgLower.includes('when is') || msgLower.includes('what time')) {\n          data.classTimetable = await getClassTimetable(message);\n        }\n        \n        // Exam timetable queries\n        if (msgLower.includes('exam') || msgLower.includes('examination') ||\n            msgLower.includes('exam date') || msgLower.includes('exam schedule') ||\n            msgLower.includes('test') || msgLower.includes('when is exam')) {\n          data.examTimetable = await getExamTimetable(message);\n        }\n      }\n\n      // ALWAYS search knowledge base first - it's the primary learning source\n      // Get more results for better context\n      knowledge = await searchKnowledge(message, 15);\n      \n      // Prioritize knowledge base content\n      if (knowledge.length > 0) {\n        data.knowledge = knowledge;\n        // If we have strong knowledge base matches, prioritize them\n        // by placing them first in the data structure\n        data.priority = 'knowledge_base';\n      }\n    }\n\n    // Construct sources for UI (RAG-style) from knowledge base\n    // Skip sources for simple greetings\n    const sources = isSimpleGreeting ? [] : (\n      data.knowledge?.map((k: any) => ({\n        title: k.name || 'Knowledge Entry',\n        source: k.source || 'Admin',\n        type: k.type || 'General',\n        snippet: k.text?.slice(0, 200) + (k.text?.length > 200 ? '...' : ''),\n        imageUrl: k.imageUrl || null,\n        imageDescription: k.imageDescription || null,\n      })) || []\n    );\n\n    // Extract images from knowledge base for display\n    const images = isSimpleGreeting ? [] : (\n      data.knowledge?.filter((k: any) => {\n        const hasImage = k.imageUrl && \n                        k.imageUrl.trim() && \n                        k.imageUrl !== 'null' && \n                        k.imageUrl !== 'undefined' &&\n                        k.imageUrl.trim().length > 0;\n        return hasImage;\n      }).map((k: any) => {\n        // Ensure URL starts with / for proper path resolution\n        let imageUrl = k.imageUrl.trim();\n        if (!imageUrl.startsWith('/') && !imageUrl.startsWith('http')) {\n          imageUrl = '/' + imageUrl;\n        }\n        return {\n          url: imageUrl,\n          description: k.imageDescription || k.name || 'Image from knowledge base',\n          title: k.name || 'Knowledge Entry',\n        };\n      }) || []\n    );\n    \n    // Debug logging\n    console.log('Knowledge entries with images check:', data.knowledge?.map((k: any) => ({\n      name: k.name,\n      hasImageUrl: !!k.imageUrl,\n      imageUrl: k.imageUrl\n    })) || []);\n    console.log('Images extracted:', images.length);\n    if (images.length > 0) {\n      console.log('Image URLs:', images.map((img: any) => img.url));\n    }\n\n    // Enhance data with metadata for better LLM understanding\n    const enhancedData = {\n      ...data,\n      sources,\n      metadata: {\n        hasKnowledge: knowledge.length > 0,\n        knowledgeCount: knowledge.length,\n        hasStaff: data.staff && data.staff.length > 0,\n        hasFees: data.fees && data.fees.length > 0,\n        hasRoom: !!data.room,\n        hasClassTimetable: data.classTimetable && data.classTimetable.length > 0,\n        hasExamTimetable: data.examTimetable && data.examTimetable.length > 0,\n        intent,\n      },\n    };\n\n    // Call Groq LLM with enhanced context\n    const llmResponse = await callGroqLLM({\n      intent,\n      userMessage: message,\n      data: enhancedData,\n     });\n\n    // Clean up the answer to remove any image URLs that might have been included\n    let cleanedAnswer = llmResponse.answer;\n    if (images.length > 0) {\n      // Remove image URLs and file paths from the answer\n      images.forEach((img: any) => {\n        // Remove the image URL if it appears in the text\n        if (img.url) {\n          cleanedAnswer = cleanedAnswer.replace(new RegExp(img.url.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&'), 'gi'), '');\n        }\n        // Remove common patterns like \"/uploads/knowledge/...\" or file extensions\n        cleanedAnswer = cleanedAnswer.replace(/\\/uploads\\/knowledge\\/[^\\s\\)]+/gi, '');\n        cleanedAnswer = cleanedAnswer.replace(/\\([^)]*\\.(jpg|jpeg|png|gif|webp)[^)]*\\)/gi, '');\n      });\n      // Clean up any double spaces or awkward spacing\n      cleanedAnswer = cleanedAnswer.replace(/\\s+/g, ' ').trim();\n    }\n\n    // Get or create conversation\n    let conversation;\n    if (conversationId) {\n      conversation = await prisma.conversation.findUnique({\n        where: { id: conversationId },\n      });\n    }\n\n    if (!conversation) {\n      // Create new conversation with title from first message\n      const title = message.length > 50 ? message.substring(0, 50) + '...' : message;\n      conversation = await prisma.conversation.create({\n        data: { title },\n      });\n    }\n\n    // Save user message\n    await prisma.message.create({\n      data: {\n        conversationId: conversation.id,\n        sender: 'user',\n        content: message,\n      },\n    });\n\n    // Save assistant response with images if available\n    await prisma.message.create({\n      data: {\n        conversationId: conversation.id,\n        sender: 'assistant',\n        content: cleanedAnswer,\n        images: images.length > 0 ? JSON.stringify(images) : null,\n      },\n    });\n\n    // Update conversation timestamp\n    await prisma.conversation.update({\n      where: { id: conversation.id },\n      data: { updatedAt: new Date() },\n    });\n    \n    console.log('ðŸ“¤ Sending response with:', {\n      answerLength: cleanedAnswer.length,\n      imagesCount: images.length,\n      imageUrls: images.map((img: any) => img.url),\n    });\n    \n    return NextResponse.json({\n      answer: cleanedAnswer,\n      sources: llmResponse.sources,\n      images: images, // Include images from knowledge base\n      conversationId: conversation.id,\n    });\n   } catch (error: any) {\n    console.error('Chat API error:', error);\n    console.error('Error stack:', error?.stack);\n    return NextResponse.json(\n      { \n        error: error?.message || 'Internal server error',\n        answer: \"I'm sorry, I encountered an error processing your request. Please try again or contact support if the issue persists.\",\n        sources: []\n      },\n       { status: 500 }\n    );\n  }\n}\n\n"],"names":[],"mappings":"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"}}]
}